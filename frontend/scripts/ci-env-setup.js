/**
 * CI/CD Environment Setup Script
 * 
 * This script creates a .env.api file from CI/CD environment variables
 * It's designed to be run during the CI/CD pipeline to properly
 * configure the application before building.
 */
const fs = require('fs');
const path = require('path');

const rootDir = path.resolve(__dirname, '..');
const envApiPath = path.join(rootDir, '.env.api');

// Environment variables to extract from CI/CD environment
const requiredVars = [
  'ELASTICSEARCH_URL', 
  'ELASTICSEARCH_API_KEY',
  'ELASTICSEARCH_INDEX'
];

// Mapping from CI/CD env vars to React app env vars
const envMapping = {
  'ELASTICSEARCH_URL': 'REACT_APP_SEARCH_ENGINE_ENDPOINT',
  'ELASTICSEARCH_API_KEY': 'REACT_APP_SEARCH_ENGINE_KEY',
  'ELASTICSEARCH_INDEX': 'REACT_APP_SEARCH_ENGINE_INDEX'
};

console.log('Setting up environment for CI/CD build...');

// Check for required environment variables
const missingVars = requiredVars.filter(varName => !process.env[varName]);
if (missingVars.length > 0) {
  console.log(`Some environment variables are not set: ${missingVars.join(', ')}`);
}

// Create .env.api content
let envContent = '# Environment variables for Financial News Engine\n';
envContent += '# Generated by CI/CD pipeline\n\n';

// Add mapped variables
Object.entries(envMapping).forEach(([ciVar, reactVar]) => {
  const value = process.env[ciVar] || '';
  envContent += `${reactVar}=${value}\n`;
});

// Set USE_ENV_API flag
envContent += 'REACT_APP_USE_ENV_API=true\n';

// Create additional environment variables if needed
if (process.env.ADDITIONAL_ENV_VARS) {
  envContent += '\n# Additional environment variables\n';
  try {
    const additionalVars = JSON.parse(process.env.ADDITIONAL_ENV_VARS);
    Object.entries(additionalVars).forEach(([key, value]) => {
      if (key.startsWith('REACT_APP_')) {
        envContent += `${key}=${value}\n`;
      } else {
        envContent += `REACT_APP_${key}=${value}\n`;
      }
    });
  } catch (e) {
    console.log('Note: Could not parse ADDITIONAL_ENV_VARS, skipping additional variables');
  }
}

// Write .env.api file
fs.writeFileSync(envApiPath, envContent);

console.log('Environment files created successfully');

// Load the environment
require('./load-env'); 