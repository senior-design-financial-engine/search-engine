version: 0.2
phases:
  install:
    runtime-versions:
      nodejs: 16
    commands:
      - echo "Running frontend deployment..."
  
  pre_build:
    commands:
      - echo "Preparing for deployment..."
      - |
        if [ -d "build" ]; then
          echo "Found build directory at root level"
          BUILD_DIR="build"
        elif [ -d "frontend/build" ]; then
          echo "Found build directory in frontend folder"
          BUILD_DIR="frontend/build"
        elif [ -f "frontend/package.json" ]; then
          echo "Building from frontend source"
          cd frontend && npm install && npm run build && cd ..
          BUILD_DIR="frontend/build"
        elif [ -f "package.json" ]; then
          echo "Building from root source"
          npm install && npm run build
          BUILD_DIR="build"
        else
          echo "ERROR: No build directory or source files found"
          exit 1
        fi
  
  build:
    commands:
      - echo "Retrieving S3 bucket name from CloudFormation stack"
      - BUCKET_NAME=$(aws cloudformation describe-stacks --stack-name $FRONTEND_STACK_NAME --query "Stacks[0].Outputs[?OutputKey=='FrontendBucketName'].OutputValue" --output text)
      - |
        if [ -z "$BUCKET_NAME" ]; then
          echo "ERROR: Could not retrieve bucket name from CloudFormation stack"
          aws s3 ls | grep frontend
          exit 1
        fi
      - echo "Syncing files to S3 bucket $BUCKET_NAME"
      - aws s3 sync $BUILD_DIR/ s3://$BUCKET_NAME/ --delete
  
  post_build:
    commands:
      - echo "Creating CloudFront invalidation"
      - CLOUDFRONT_ID=$(aws cloudformation describe-stacks --stack-name $FRONTEND_STACK_NAME --query "Stacks[0].Outputs[?OutputKey=='CloudFrontDistributionId'].OutputValue" --output text)
      - |
        if [ -n "$CLOUDFRONT_ID" ]; then
          aws cloudfront create-invalidation --distribution-id $CLOUDFRONT_ID --paths "/*"
        else
          echo "WARNING: Could not retrieve CloudFront distribution ID"
        fi
      - echo "Frontend deployment completed"

artifacts:
  files:
    - '**/*'
  discard-paths: no 